<!DOCTYPE html>
<html>
  <head>
    <title>Lezgi numbers converter demo</title>
    <meta charset="UTF-8" />
  </head>
  <body>
    <script src="https://unpkg.com/lezgi-numbers@1.0.3/dist/lezgi-numbers.js"></script>

    <h2>Lezgi numbers converter demo</h2>

    <form>
      <label for="any-number">Number:</label><br />
      <input type="number" id="any-number" name="any-number" /><br />
      <span id="number-in-lezgi"></span>
      <br /><br />
      <label for="lezgi-numeral">Lezgi numeral:</label><br />
      <input type="text" id="lezgi-numeral" name="lezgi-numeral" /><br />
      <span id="number-from-lezgi"></span>
      <br /><br />
    </form>
    <p>
      <b>Note:</b>
      <i>
        To be able to run the text-to-speech, you need to run root directory of the project and run
        the command </i
      ><code>`python -m http.server`</code
      ><i> and open the browser at `http://localhost:8000/demo/` </i>
    </p>
    <button onclick="play()">Play Text-To-Speech</button>

    <script>
      document.getElementById('any-number').oninput = (e) => {
        try {
          // Convert numbers to Lezgi numerals
          document.getElementById('number-in-lezgi').innerText = LezgiNumbers.numToLezgi(
            parseInt(e.target.value),
          );
        } catch (e) {
          console.error(e.message);
        }
      };

      document.getElementById('lezgi-numeral').oninput = (e) => {
        try {
          // Convert Lezgi numerals to numbers
          document.getElementById('number-from-lezgi').innerText = LezgiNumbers.lezgiToNum(
            e.target.value,
          );
        } catch (e) {
          console.error(e.message);
        }
      };

      function concatenateAudiosBrowser(urls) {
        // @ts-ignore
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        async function fetchAudio(url) {
          const response = await fetch(url);
          const arrayBuffer = await response.arrayBuffer();
          return audioContext.decodeAudioData(arrayBuffer);
        }

        Promise.all(urls.map((url) => fetchAudio(url)))
          .then((buffers) => {
            let totalLength = buffers.reduce((acc, buffer) => acc + buffer.length, 0);
            let output = audioContext.createBuffer(1, totalLength, audioContext.sampleRate);

            let offset = 0;
            buffers.forEach((buffer) => {
              output.getChannelData(0).set(buffer.getChannelData(0), offset);
              offset += buffer.length;
            });
            return output;
          })
          .then((concatenatedBuffer) => {
            let source = audioContext.createBufferSource();
            source.buffer = concatenatedBuffer;
            source.connect(audioContext.destination);
            source.start(0);
          });
      }
      const audios = ['кьве', ' ', 'миллиард', 'ни', ' ', 'сад'];
      const urls = audios.map((audio) => `../static/arthur/mp3/${audio}.mp3`);
      function play() {
        concatenateAudiosBrowser(urls);
      }
    </script>
  </body>
</html>
